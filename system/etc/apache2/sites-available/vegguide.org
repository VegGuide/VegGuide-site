# modules needed:
#   alias
#   auth_basic
#   authn_file ?
#   authz_default (order, deny)
#   authz_groupfile ?
#   authz_host ?
#   authz_user ?
#   cgi (for mailman?)
#   deflate
#   env (for ssl?)
#   expires
#   headers
#   mime
#   proxy
#   proxy_http
#   rewrite
#   setenvif (for ssl?)
#   ssl
#   status ?

# proxy.conf
#
#        <Proxy http://localhost:*/*>
#                Order deny,allow
#                Allow from all
#        </Proxy>

<VirtualHost _default_:80>
    CustomLog /var/log/apache2/access.log combined
    ServerSignature On

    RewriteEngine On

    AddType text/javascript .js

    Header append P3P "policyref=\"http://www.vegguide.org/w3c/p3p.xml\", CP=\"ALL DSP COR CURa ADMa \DEVa TAIa PSAa PSDa OUR IND PHY ONL COM NAV DEM STA\""

    RewriteEngine On

    #RewriteRule   !^/down.html$  -  [C]
    #RewriteRule   .*  /down.html  [R,L]

    # This dates back to much older versions of the site, when most pages
    # had a .mhtml extension.
    RewriteRule   (.+)\.mhtml$            $1.html                                                     [R=permanent,L]

    RewriteCond  %{HTTP_HOST}             ^vegguide\.org
    RewriteRule  (.*)                     http://www.vegguide.org$1                                   [R,L]


    # Some brain-damaged crawler is requesting URIs like this
    RewriteRule   ^(.+\.rss)%3[Ff]                            /                                       [R=permanent,L]

    # This next group is for backwards compatibility with the version
    # of site immediately before 3.0 The trailing question marks
    # prevent the rewrite engine from including the query string in
    # the redirect URI
    RewriteCond   %{QUERY_STRING}         location_id=(\d+)
    RewriteRule   ^/location/view\.html                       /region/%1?                             [R=permanent,L]
    RewriteCond   %{QUERY_STRING}         location_id=(\d+)
    RewriteRule   ^/location/data\.rss                        /region/%1.rss?                         [R=permanent,L]
    RewriteCond   %{QUERY_STRING}         location_id=(\d+)
    RewriteRule   ^/location/most_recent.rss                  /region/%1/recent.rss?                  [R=permanent,L]
    RewriteCond   %{QUERY_STRING}         location_id=(\d+)
    RewriteRule   ^/location/most_recent_vendors\.rss         /region/%1/recent.rss?entries_only=1    [R=permanent,L]
    RewriteCond   %{QUERY_STRING}         location_id=(\d+)
    RewriteRule   ^/location/most_recent_reviews\.rss         /region/%1/recent.rss?reviews_only=1    [R=permanent,L]

    RewriteCond   %{QUERY_STRING}         vendor_id=(\d+)
    RewriteRule   ^/vendor/view\.html                         /entry/%1?                              [R=permanent,L]
    RewriteCond   %{QUERY_STRING}         vendor_id=(\d+)
    RewriteRule   ^/vendor/reviews\.html                      /entry/%1?                              [R=permanent,L]

    RewriteCond   %{QUERY_STRING}         user_id=(\d+)
    RewriteRule   ^/user/view\.html                           /user/%1?                               [R=permanent,L]

    RewriteRule   ^/index\.html                               /                                       [R=permanent,L]
    RewriteRule   ^/faq\.html                                 /site/help                              [R=permanent,L]
    RewriteRule   ^/rss/data_feed.html                        /site/data_feed                         [R=permanent,L]
    RewriteRule   ^/rss                                       /site/feeds                             [R=permanent,L]
    RewriteRule   ^/news                                      /site/news                              [R=permanent,L]

    # Old URI for opensearch widget    
    RewriteCond   %{QUERY_STRING}         search=(.+)
    RewriteRule   ^/submit/search                             /site/search?search_text=%1             [R=permanent,L]

    RewriteRule   ^/(location|vendor|noauth)/?$               /                                       [R,L]

    RewriteRule   ^/plain.*                                   -                                       [G,L]
    RewriteRule   ^/(events?|location|logged-in||news|noauth|vendor)/.*\.html  -                      [G,L]
    RewriteRule   ^/(source|privacy|about|contact|info_key|contest|todo).html  -                      [G,L]
    RewriteRule   ^/(search|printable|location_suggestion|promo_cards|vegsiteinabox).html    -        [G,L]
    RewriteRule   ^/by_(name|geocode|zipcode).html            -                                       [G,L]
    RewriteRule   ^/submit.*                                  -                                       [G,L]

    # Random requests for stuff that we don't have
    RewriteRule   ^/maps/c/ui/HovercardLauncher/dommanifest\.js$  -                                   [G,L]
    RewriteRule   ^/\.api/main\.js                                -                                   [G,L]
    RewriteRule   ^/ge/v/1/4/loader\.js                           -                                   [G,L]
    RewriteRule   ^/__utm\.gif                                    -                                   [G,L]
    RewriteRule   ^\/apple-touch-icon\.png                        -                                   [G,L]
    RewriteRule   ^\/apple-touch-icon-precomposed\.png            -                                   [G,L]
    RewriteRule   ^\/labels\.rdf                                  -                                   [G,L]
    RewriteRule   ^\/sugest\.css                                  -                                   [G,L]

    # you are l33t
    RewriteRule   ^/https://www\.paypal\.com/cgi-bin/webscr   -                                       [F,L]
    RewriteRule   \.(asp|cfn|php|dll)$                        -                                       [F,L]
    RewriteRule   (ikonboard\.cgi|YaBB\.pl)$                  -                                       [F,L]
    RewriteRule   ^\/add\.php3$                               -                                       [F,L]
    RewriteRule   ^\/uds.*                                    -                                       [F,L]
    RewriteRule   ^\/img.*                                    -                                       [F,L]
    RewriteRule   ^\/\.\.\.                                   -                                       [F,L]

    RewriteRule   /rss/static/all\w+\.rss                     /site.rss                               [R=permanent,L]

    RewriteRule   /maintenance.html                           /                                       [R,L]

    RewriteRule   ^(/mailman|/pipermail)(.*)  https://%{HTTP_HOST}$1$2 [R=permanent,L]

    # something keep requesting URIs like /foo/bar/favicon.ico
    RewriteRule   !^/images/favicon\.ico                      -                                       [C]
    RewriteRule   ^.+/favicon.(gif|ico)$                      /images/favicon.ico                     [R,L]

    RewriteRule   !^/404               - [C]
    RewriteRule   !^(/\d+)?/css        - [C]
    RewriteRule   !^/entry-images      - [C]
    RewriteRule   !^/user-images       - [C]
    RewriteRule   !^(/\d+)?/images     - [C]
    RewriteRule   !^(/\d+)?/js         - [C]
    RewriteRule   !^/skin-images       - [C]
    RewriteRule   !^/static            - [C]
    RewriteRule   !^/w3c               - [C]
    RewriteRule   !^/robots\.txt$      - [C]
    RewriteRule   !^/favicon\.ico$     - [C]
    RewriteRule   ^(.*)                http://localhost:8088$1 [P,L]

    <Location />
        SetOutputFilter DEFLATE
    </Location>

    AliasMatch   (/\d+)?/css(.+)       /usr/local/share/vegguide/css$2
    AliasMatch   (/\d+)?/images(.+)    /usr/local/share/vegguide/images$2
    Alias        /static/rss           /var/cache/vegguide/rss
    Alias        /static               /usr/local/share/vegguide/static
    Alias        /w3c                  /usr/local/share/vegguide/w3c

    Alias        /robots.txt           /usr/local/share/vegguide/static/robots.txt

    Alias        /entry-images         /var/lib/vegguide/entry-images
    Alias        /user-images          /var/lib/vegguide/user-images
    AliasMatch   (/\d+)?/js(.+)        /var/lib/vegguide/js$2
    Alias        /skin-images          /var/lib/vegguide/skin-images

    <LocationMatch "^/\d+/(css|images|js)">
        ExpiresActive On
        ExpiresDefault "now plus 10 years"
    </LocationMatch>

    ErrorDocument 503  /static/503.html
</VirtualHost>

<VirtualHost _default_:443>
    SSLEngine on
    SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL

    SSLCertificateFile    /etc/ssl/certs/www.vegguide.org.crt
    SSLCertificateKeyFile /etc/ssl/private/www.vegguide.org.key

    SSLOptions +StdEnvVars

    SetEnvIf User-Agent ".*MSIE.*" \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0

    ScriptAlias   /mailman/          /usr/lib/cgi-bin/mailman/
    Alias         /pipermail/        /var/lib/mailman/archives/public/
    Alias         /images/mailman/   /usr/share/images/mailman/

    RewriteEngine On
    RewriteRule   ^/mailman/?$         /mailman/listinfo/  [R,L]
</VirtualHost>
