# Static files and backend proxy
server {
    error_log  /var/log/nginx/vegguide.org/error.log;
    access_log /var/log/nginx/vegguide.org/access.log;

    listen 80;
    server_name www.vegguide.org vegguide.org;
    
    add_header P3P "policyref=\"http://www.vegguide.org/w3c/p3p.xml\", CP=\"ALL DSP COR CURa ADMa \DEVa TAIa PSAa PSDa OUR IND PHY ONL COM NAV DEM STA\"";

    location ~ ^(/mailman|/pipermail)(.*) {
        set $path $1$2;
        rewrite  ^  https://lists.vegguide.org$path  permanent;
    }

    #rewrite  !^/down.html$  /down.html  redirect;
    location = /down.html {
        rewrite  ^  /;
    }

    set $var_dir   /var/lib/vegguide;
    set $cache_dir /var/cache/vegguide;
    set $share_dir /usr/local/share/vegguide;

    error_page 503 $share_dir/static/503.html;

    location ~ .*favicon\.gif$ {
        rewrite  ^  /favicon.ico;
    }

    location = /favicon.ico {
        root $share_dir/images;
    }

    location ~ (?:/\w*)?/css/vegguide-combined\.css {
        expires max;
        root $cache_dir/css;
    }
       
    location ~ (?:/\w*)?/(css|images) {
        expires max;
        root $share_dir/$1;
    }

    location ~ (?:/\w*)?/js {
        expires max;
        root $var_dir/js;
    }

    location ^~ /static/rss {
        root $cache_dir/rss;
    }

    location ~ ^/(static|w3c) {
        root $share_dir/$1;
    }

    location ^~ /robots.txt {
        root $share_dir/static;
    }

    location ~ ^/(entry-images|user-images|skin-images) {
        root $var_dir/$1;
    }
    
    location ^~ /plain {
        return 410;
    }
    
    location ~ ^/(?:events?|location|logged-in||news|noauth|vendor)/.*\.html {
        return 410;
    }

    location ~ ^/(?:source|privacy|about|contact|info_key|contest|todo).html {
        return 410;
    }

    location ~ ^/(?:search|printable|location_suggestion|promo_cards|vegsiteinabox).html {
        return 410;
    }

    location ~ ^/by_(?:name|geocode|zipcode).html {
        return 410;
    }

    location ^~ /submit {
        return 410;
    }

    # Random requests for stuff that we don't have - some are hack attempts
    location ~ ^/maps/c/ui/HovercardLauncher/dommanifest\.js$ {
        return 404;
    }

    location ^~ /.api/main.js  {
        return 404;
    }

    location ^~ /ge/v/1/4/loader.js {
        return 404;
    }

    location ^~ /__utm.gif {
        return 404;
    }

    location ~ ^\/apple-touch-icon(?:-precomposed)?\.png {
        return 404;
    }

    location ^~ \/labels.rdf {
        return 404;
    }

    location ^~ \/sugest.css {
        return 404;
    }

    # This stuff seems to be hack attempts
    location ^~ /https://www.paypal.com/cgi-bin/webscr {
        return 403;
    }

    location ~ \.(?:asp|cfn|php|dll)$ {
        return 403;
    }

    location ~ (?:ikonboard\.cgi|YaBB\.pl)$ {
        return 403;
    }

    location ~ ^\/add\.php3$ {
        return 403;
    }

    location ~ ^\/uds.* {
        return 403;
    }

    location ~ ^\/img.* {
        return 403;
    }

    location ~ ^\/\.\.\. {
        return 403;
    }

    # This dates back to much older versions of the site, when most pages
    # had a .mhtml extension.
    location ~ (.*/)?([^/]+)\.mhtml$ {
        set $path $1$2;
        rewrite  ^  $path.html permanent;
    }

    # Some brain-damaged crawler was requesting URIs like this
    location ~ ^.+\.rss%3[Ff] {
        rewrite  ^  /  permanent;
    }

    location ^~ /location {
        if ( $args_location_id ~ (\d+) ) {
            set $region_id $1;
            rewrite  ^/location/view\.html         /region/$region_id             permanent;
            rewrite  ^/location/data\.rss          /region/$region_id.rss         permanent;
            rewrite  ^/location/most_recent\.rss   /region/$region_id/recent.rss  permanent;
            rewrite  ^/location/most_recent_vendors\.rss   /region/$region_id/recent.rss?entries_only=1  permanent;
            rewrite  ^/location/most_recent_reviews\.rss   /region/$region_id/recent.rss?reviews_only=1  permanent;
        }
        rewrite  ^  /  break;
    }

    location ^~ /vendor {
        if ( $args_vendor_id ~ (\d+) ) {
            set $vendor_id $1;
            rewrite  ^/vendor/view\.html     /entry/$vendor_id          permanent;
            rewrite  ^/vendor/reviews\.html  /entry/$vendor_id/reviews  permanent;
        }
        rewrite  ^  /  break;
    }

    location ^~ /user {
        if ( $args_user_id ~ (\d+) ) {
            set $user_id $1;
            rewrite  ^/user/view\.html  /user/$user_id  permanent;
        }
        rewrite  ^  /  break;
    }

    location = /index.html {
        rewrite  ^  / permanent;
    }

    location = /faq.html {
        rewrite  ^  /site/hrlp permanent;
    }

    location = /rss/data_feed.html {
        rewrite  ^  /site/data_feed  permanent;
    }

    location ^~ /rss {
        rewrite  ^  /site/feeds  permanent;
    }

    location ^~ /news {
        rewrite  ^  /site/news  permanent;
    }
        
    location ~ /rss/static/all\w+\.rss {
        rewrite  ^  /site.rss permanent;
    }

    location ^~ /noauth {
        rewrite  ^  /  redirect;
    }

    location ~ ^/submit/search {
        rewrite  ^/submit/search  /site/search?search_text=$args_search  permanent;
    }

    location / {
        try_files $uri @backend;
    }
    
    location @backend {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 90;
        proxy_send_timeout    90;
        proxy_read_timeout    90;
        proxy_buffers         32 4k;

        proxy_pass http://localhost:8088;
    }
}

server {
    listen 80;
    server_name *.vegguide.org;

    rewrite  ^  http://www.vegguide.org$request_uri?  permanent;
}

server {
    listen 443;
    server_name lists.vegguide.org;

    ssl on;
    ssl_certificate     /etc/ssl/certs/www.vegguide.org.crt;
    ssl_certificate_key /etc/ssl/private/www.vegguide.org.key;

    root /usr/lib;

    location = / {
        rewrite  ^  /mailman/listinfo  permanent;
    }
 
    location / {
        rewrite  ^  /mailman$uri?$args;
    }
 
    location = /mailman/ {
        rewrite  ^  /mailman/listinfo  permanent;
    }
    
    location /mailman/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 90;
        proxy_send_timeout    90;
        proxy_read_timeout    90;
        proxy_buffers         32 4k;

        proxy_pass http://127.0.0.1:7777/;
    }
 
    location /cgi-bin {
        rewrite  ^/cgi-bin(.*)$  $1  permanent;
    }
 
    location /images/mailman {
        alias /var/lib/mailman/icons;
    }
 
    location /pipermail {
        alias /var/lib/mailman/archives/public;
        autoindex on;
    }
}    

server {
    listen 80;

    rewrite  ^  http://www.vegguide.org$request_uri?  permanent;
}
