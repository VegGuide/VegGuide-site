#!/usr/bin/perl

use strict;
use warnings;

use DateTime;
use DateTime::Format::HTTP;
use Email::Simple::Creator;
use File::Tail;
use VegGuide::JSON;


my $file = '/var/log/apache2-backend/error.log';

my $tail = _make_tail();
my @messages;

while ( defined ( my $line = $tail->read() ) )
{
    my %message;

    if ( $line =~ /^([^[].*)/ )
    {
        $message{date}  = DateTime->now( time_zone => 'America/Chicago' );
        $message{level} = 'warning';
        $message{text}  = $1;
    }
    elsif ( $line =~ /^\[([^]]+)\] \[(error|warning)] vegguide: (.+) / )
    {
        $message{date}  = DateTime::Format::HTTP->parse_datetime( $1, 'local' );
        $message{level} = $2;

        my $text = $3;
        if ( $text =~ /^{.+}$/ )
        {
            $text =~ s/(\\.)/eval $1/eg;

            my $error = VegGuide::JSON->decode($text);

            $text  = '    URI: ' . $error->{uri};
            if ( $error->{user} )
            {
                $text .= "\n";
                $text .= '    User: ' . $error->{user}
            }

            my $msg = $error->{error};
            $msg =~ s/^\s*/    /gm;

            $text .= "\n";
            $text .= $msg;
        }

        $message{text} = $text;
    }

    next unless $message{text};

    push @messages, \%message;
}

sub _make_tail
{
    return
        File::Tail->new( name       => $file,
                         resetafter => 3600 * 8,
                       );
}
